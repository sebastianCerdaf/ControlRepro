<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ControlRepro - Reposición Inteligente</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<link rel="stylesheet" href="../../style.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@500;600&display=swap" rel="stylesheet">
  <style>
    .header-desordenado {
      position: relative;
      height: 120px;
    }
    .logo-centrado {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 240px;
      pointer-events: none;
      z-index: 0;
    }
    .boton-izquierda {
      position: absolute;
      top: 20px;
      left: 20px;
    }
    .titulo-central {
      text-align: center;
      margin-top: 40px;
      font-size: 1.8rem;
      font-weight: bold;
    }
    header.header-desordenado {
      z-index: 0;
    }
    form.formulario,
    .botonera {
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body id="app">

<div class="main-glass-card" id="innerApp">
    <header class="header-desordenado">
      <button class="cerrar-sesion" @click="confirmarCerrarSesion">Cerrar Sesión</button>
      <img src="../../assets/Icon.png" alt="Logo ControlRepro" class="logo-principal logo-centrado" />
    </header>
    <h1 class="titulo-central">ControlRepro - Reposición Inteligente</h1>

    <form @submit.prevent="agregarProducto" class="formulario">
      <div class="autocomplete-wrapper">
        <input v-model="nuevoProducto.id"
               @input="buscarSugerencias"
               @focus="mostrarSugerencias = true"
             @blur="ocultarSugerencias"
             placeholder="ID o Nombre Producto"
             required />
      <ul v-if="mostrarSugerencias && sugerencias.length" class="sugerencias">
        <li v-for="sugerencia in sugerencias" @mousedown.prevent="seleccionarProducto(sugerencia)">
          {{ sugerencia.id }} - {{ sugerencia.nombre }}
        </li>
      </ul>
    </div>

    <input v-model="nuevoProducto.categoria" :readonly="productoBloqueado" placeholder="Categoría" required />
    <input v-model="nuevoProducto.precioCaja30" type="number" :readonly="productoBloqueado" placeholder="Precio por Caja" required />
    <input v-model.number="nuevoProducto.stock" type="number" :readonly="false" placeholder="Cajas Ingresadas" required />
    <input v-model.number="nuevoProducto.stockMinimo" type="number" :readonly="false" placeholder="Punto de Reposición" required />
  </form>

  <div class="botonera unificada">
    <button type="submit" @click="agregarProducto" class="azul">Agregar Producto</button>
    <button type="button" @click="borrarCamposProducto" class="gris">Borrar Campos</button>
    <button @click="seleccionarRuta" class="boton-exportar azul">📁 Seleccionar Carpeta</button>
    <button @click="exportarExcel" class="boton-exportar azul">📤 Exportar a Excel</button>
    <button @click="mostrarModal" class="boton-exportar gris">📇 Contacto de Proveedores</button>
  </div>

  <p v-if="rutaGuardado" style="font-style: italic; color: gray;">📂 Carpeta actual: {{ rutaGuardado }}</p>

  <div class="tabla-productos-wrapper" v-if="productos.length">
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Categoría</th>
          <th>Cajas</th>
          <th>Punto Reposición</th>
          <th>Precio Caja</th>
          <th>Proveedores</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(producto, index) in productos"
            :key="index"
            :class="{ 'bajo-stock': producto.stock <= producto.stockMinimo }">
          <td><strong>{{ producto.nombre }}</strong></td>
          <td>{{ producto.categoria }}</td>
          <td>{{ producto.stock }}</td>
          <td>{{ producto.stockMinimo }}</td>
          <td>${{ producto.precioCaja30 }}</td>
          <td>
            <ul class="proveedores-tabla">
              <li v-for="(prov, i) in producto.proveedores" :key="i">
                {{ prov.nombre }} <small>({{ prov.leadTime }} días)</small>
              </li>
            </ul>
          </td>
          <td>
            <button class="eliminar" @click="eliminarProducto(index)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="modalAcceso" class="modal hidden">
  <div class="modal-contenido">
    <img src="../../assets/Icon.png" alt="Logo ControlRepro" class="modal-logo" />
    <h2>Acceso restringido</h2>
    <p>Para ingresar a la sección de contactos, necesitas autorización de un administrador.</p>
    <input type="password" id="codigoInput" placeholder="Ingresa el código de acceso" />
    <div class="modal-botones">
      <button @click="validarCodigo" class="azul">Acceder</button>
      <button @click="cerrarModal" class="gris">Cancelar</button>
    </div>
    <p id="mensajeError" class="modal-error"></p>
  </div>
</div>

<div id="modalCerrarSesion" class="modal hidden">
  <div class="modal-contenido">
    <h2>¿Cerrar sesión?</h2>
    <p>Se perderán los datos actuales si no los ha exportado.</p>
    <div class="modal-botones">
      <button @click="cerrarSesion" class="azul">Sí, cerrar sesión</button>
      <button @click="cerrarModalCerrarSesion" class="gris">Cancelar</button>
    </div>
  </div>
</div>
  <div id="popupError" class="popup-error"></div>
</div>

<script src="../../BDProductos.js"></script>
<script src="../scripts/MainView.js"></script>

<style>
  .popup-error {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #ff4d4d;
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    opacity: 0;
    z-index: 999;
    transition: opacity 0.3s ease;
    pointer-events: none;
    font-weight: bold;
  }
  .popup-error.visible {
    opacity: 1;
  }
  .modal.hidden {
    display: none;
  }
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .modal-contenido {
    background: white;
    padding: 24px 32px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }
  .modal-botones {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }
</style>

</body>
</html>
